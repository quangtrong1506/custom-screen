name: Build and Release

on:
   push:
      branches: [main]

jobs:
   build-and-release:
      runs-on: windows-latest

      steps:
         - name: Checkout code
           uses: actions/checkout@v4
           with:
              fetch-depth: 0

         - name: Setup Node.js
           uses: actions/setup-node@v4
           with:
              node-version: 18
              cache: 'npm'

         - name: Install dependencies
           run: npm ci

         - name: Run ESLint
           run: npm run lint

         - name: Ensure CHANGELOG.md exists
           shell: bash
           run: |
              if [ ! -f CHANGELOG.md ]; then echo "# Changelog" > CHANGELOG.md; fi

         - name: Update CHANGELOG.md
           shell: bash
           run: |
              npx conventional-changelog-cli -p angular -i CHANGELOG.md -s || true
              git add CHANGELOG.md
              git diff --cached --quiet || git commit -m "docs: update CHANGELOG.md"

         - name: Bump version and push tag
           shell: bash
           run: |
              version=$(npm version patch --no-git-tag-version)
              git add package.json package-lock.json
              git commit -m "chore: bump version to $version"
              git tag $version
              git push origin HEAD --tags

         - name: Build Electron app
           run: npm run build

         - name: Release app
           uses: softprops/action-gh-release@v2
           with:
              generate_release_notes: true
              files: |
                 dist/*.exe
           env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
